<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>v2 开发文档 | 悬浮字幕</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="在 Android 上高亮显示直播翻译弹幕为悬浮字幕">
    <link rel="preload" href="/assets/css/0.styles.06da0ae5.css" as="style"><link rel="preload" href="/assets/js/app.47aadde2.js" as="script"><link rel="preload" href="/assets/js/2.f87f6062.js" as="script"><link rel="preload" href="/assets/js/10.192c4040.js" as="script"><link rel="prefetch" href="/assets/js/11.bf5085ae.js"><link rel="prefetch" href="/assets/js/12.8b095cee.js"><link rel="prefetch" href="/assets/js/13.ba82467d.js"><link rel="prefetch" href="/assets/js/14.7730d457.js"><link rel="prefetch" href="/assets/js/15.ad1b739f.js"><link rel="prefetch" href="/assets/js/16.52473345.js"><link rel="prefetch" href="/assets/js/17.6c4ebf61.js"><link rel="prefetch" href="/assets/js/18.cde28da0.js"><link rel="prefetch" href="/assets/js/19.f0e91613.js"><link rel="prefetch" href="/assets/js/20.ad36334c.js"><link rel="prefetch" href="/assets/js/21.1780817a.js"><link rel="prefetch" href="/assets/js/22.106e90ec.js"><link rel="prefetch" href="/assets/js/23.d73d7947.js"><link rel="prefetch" href="/assets/js/24.bf7ea89d.js"><link rel="prefetch" href="/assets/js/25.20adadee.js"><link rel="prefetch" href="/assets/js/3.bc26c65b.js"><link rel="prefetch" href="/assets/js/4.ed332ec4.js"><link rel="prefetch" href="/assets/js/5.f138a364.js"><link rel="prefetch" href="/assets/js/6.620ad76f.js"><link rel="prefetch" href="/assets/js/7.7abfe022.js"><link rel="prefetch" href="/assets/js/8.f329cfd7.js"><link rel="prefetch" href="/assets/js/9.0fe50bda.js">
    <link rel="stylesheet" href="/assets/css/0.styles.06da0ae5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/danmaqua-logo.png" alt="悬浮字幕" class="logo"> <span class="site-name can-hide">悬浮字幕</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/intro.html" class="nav-link">
  介绍
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="功能" class="dropdown-title"><span class="title">功能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/features/subscription.html" class="nav-link">
  订阅主播
</a></li><li class="dropdown-item"><!----> <a href="/features/danmaku.html" class="nav-link">
  弹幕服务
</a></li><li class="dropdown-item"><!----> <a href="/features/filter.html" class="nav-link">
  弹幕过滤
</a></li><li class="dropdown-item"><!----> <a href="/features/floating.html" class="nav-link">
  悬浮窗
</a></li><li class="dropdown-item"><!----> <a href="/features/history.html" class="nav-link">
  弹幕历史
</a></li><li class="dropdown-item"><!----> <a href="/features/tips.html" class="nav-link">
  小技巧
</a></li></ul></div></div><div class="nav-item"><a href="/download.html" class="nav-link">
  下载
</a></div><div class="nav-item"><a href="/changelogs.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Bot 版" class="dropdown-title"><span class="title">Bot 版</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bot/userpage.html" class="nav-link">
  我是观众，如何使用
</a></li><li class="dropdown-item"><!----> <a href="/bot/dev.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Bot 快速搭建教程
</a></li><li class="dropdown-item"><!----> <a href="/bot/config.html" class="nav-link">
  Bot 配置说明
</a></li><li class="dropdown-item"><!----> <a href="/bot/run_with_docker.html" class="nav-link">
  Docker 部署教程
</a></li><li class="dropdown-item"><!----> <a href="/bot/dmsrc_api.html" class="nav-link">
  弹幕源 API
</a></li><li class="dropdown-item"><!----> <a href="/bot/scheduler_usage.html" class="nav-link">
  计划任务使用教程
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fython/danmaqua-android" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/intro.html" class="nav-link">
  介绍
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="功能" class="dropdown-title"><span class="title">功能</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/features/subscription.html" class="nav-link">
  订阅主播
</a></li><li class="dropdown-item"><!----> <a href="/features/danmaku.html" class="nav-link">
  弹幕服务
</a></li><li class="dropdown-item"><!----> <a href="/features/filter.html" class="nav-link">
  弹幕过滤
</a></li><li class="dropdown-item"><!----> <a href="/features/floating.html" class="nav-link">
  悬浮窗
</a></li><li class="dropdown-item"><!----> <a href="/features/history.html" class="nav-link">
  弹幕历史
</a></li><li class="dropdown-item"><!----> <a href="/features/tips.html" class="nav-link">
  小技巧
</a></li></ul></div></div><div class="nav-item"><a href="/download.html" class="nav-link">
  下载
</a></div><div class="nav-item"><a href="/changelogs.html" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Bot 版" class="dropdown-title"><span class="title">Bot 版</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bot/userpage.html" class="nav-link">
  我是观众，如何使用
</a></li><li class="dropdown-item"><!----> <a href="/bot/dev.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Bot 快速搭建教程
</a></li><li class="dropdown-item"><!----> <a href="/bot/config.html" class="nav-link">
  Bot 配置说明
</a></li><li class="dropdown-item"><!----> <a href="/bot/run_with_docker.html" class="nav-link">
  Docker 部署教程
</a></li><li class="dropdown-item"><!----> <a href="/bot/dmsrc_api.html" class="nav-link">
  弹幕源 API
</a></li><li class="dropdown-item"><!----> <a href="/bot/scheduler_usage.html" class="nav-link">
  计划任务使用教程
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/fython/danmaqua-android" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="v2-开发文档"><a href="#v2-开发文档" class="header-anchor">#</a> v2 开发文档</h1> <blockquote><p>本文档介绍的是 <a href="https://github.com/danmaqua/danmaqua-telegrambot" target="_blank" rel="noopener noreferrer">danmaqua-telegrambot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的 v2 版本，如果你仍在使用 v1 版本且不想迁移，请移步到 <a href="/bot/dev_v1.html">v1 开发文档</a>。</p></blockquote> <p>你可以选择搭建自己的实例来提供其他 VTubers 的同传频道，或者为我们的 Bot 开发贡献你的力量。同时我们欢迎提交第三方的同传频道到 Telegram 频道 <code>@danmaqua</code> ，方便观众们寻找。</p> <p>项目源码： <a href="https://github.com/danmaqua/danmaqua-telegrambot" target="_blank" rel="noopener noreferrer">https://github.com/danmaqua/danmaqua-telegrambot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="运行自己的-bot-实例"><a href="#运行自己的-bot-实例" class="header-anchor">#</a> 运行自己的 Bot 实例</h2> <p>保证运行环境安装有 Node.js 12+ 和 NPM 包管理，并在 Telegram <code>@BotFather</code> 申请你自己的 Bot 账号。</p> <p><strong>2020/7/11 更新：现在我们封装了一个 Docker 镜像大幅简化了搭建 Bot 实例的流程，想要了解如何使用 Docker 运行 Bot 实例可以<a href="/bot/run_with_docker.html">点击这里</a></strong></p> <h3 id="_0、了解-bot-v2-架构"><a href="#_0、了解-bot-v2-架构" class="header-anchor">#</a> 0、了解 Bot v2 架构</h3> <p>Bot v2 版本将程序分为 <strong>Bot 本体+弹幕源服务器</strong> 两部分：</p> <ul><li><strong>Bot 本体</strong>：负责 Telegram API 通讯、转发配置管理和用户交互部分，从各个弹幕源服务器中获取不同平台的弹幕数据，根据配置将符合同传规则的弹幕转发到 Telegram 频道/对话中。</li> <li><strong>弹幕源服务器</strong>：负责直播平台弹幕协议通讯，并通过 WebSocket 协议向其他客户端提供统一数据格式的弹幕信息。</li></ul> <p>弹幕协议从 Bot 本体解耦出来后，我们在添加其他直播平台弹幕协议时无需再去修改 Bot 本体的代码，同时也能够将与直播平台的弹幕连接共享给其他程序。</p> <p>关于弹幕源服务器的 API 定义，可以阅读 <a href="/bot/dmsrc_api.html">弹幕源 API</a> 文档，如果你不打算自己实现弹幕源，请忽略这一段。</p> <p>在架设 Bot 实例时，你可以选择 Bot 本体和弹幕源不在同一台机器上，也可以直接在同一台机器上运行。这取决于<strong>你有多少服务会共用弹幕源</strong>，以及你运行机器人本体的机器<strong>能否与直播平台间保持良好的弹幕连接</strong>。（在设计出弹幕源服务器后，我们把 Bot v1 中的弹幕连接代理设置给去掉了，如果你仍然需要这个功能的话，请告诉我。）</p> <h3 id="_1、下载项目源码并安装依赖"><a href="#_1、下载项目源码并安装依赖" class="header-anchor">#</a> 1、下载项目源码并安装依赖</h3> <p>首先，你需要获取 <a href="https://github.com/danmaqua/danmaqua-telegrambot" target="_blank" rel="noopener noreferrer">danmaqua-telegrambot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的项目源码。</p> <p>可以通过 <a href="https://github.com/danmaqua/danmaqua-telegrambot/releases" target="_blank" rel="noopener noreferrer">GitHub Releases<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 下载打包好的发布版本，或者使用 Git 克隆最新的源码：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> clone https://github.com/danmaqua/danmaqua-telegrambot
</code></pre></div><p>获取源码后，进入项目根目录，执行 <code>npm install</code> 进行安装项目必须的依赖。</p> <h3 id="_2、配置-bot"><a href="#_2、配置-bot" class="header-anchor">#</a> 2、配置 Bot</h3> <p>在启动之前，你需要根据自己的实际环境进行配置。</p> <h4 id="_2-1、弹幕源配置"><a href="#_2-1、弹幕源配置" class="header-anchor">#</a> 2.1、弹幕源配置</h4> <p>打开根目录中的 <code>dmsrc.config.js</code> 修改弹幕源服务器配置。</p> <p><strong>如果你的机器环境端口 8001 和 8002 都是空闲的，可以直接跳过这一步节省时间。</strong></p> <p>我们为你实现了哔哩哔哩和斗鱼直播平台的弹幕源，通常你只需要配置好弹幕源端口，让 Bot 能够正常连上即可。如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    bilibili<span class="token operator">:</span> <span class="token punctuation">{</span>
        port<span class="token operator">:</span> <span class="token number">8001</span><span class="token punctuation">,</span>
        basicAuth<span class="token operator">:</span> <span class="token string">'testPassword'</span><span class="token punctuation">,</span>
        bilibiliProtocol<span class="token operator">:</span> <span class="token string">'ws'</span><span class="token punctuation">,</span>
        reconnectCron<span class="token operator">:</span> <span class="token string">'0 0 3 * * *'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    douyu<span class="token operator">:</span> <span class="token punctuation">{</span>
        port<span class="token operator">:</span> <span class="token number">8002</span><span class="token punctuation">,</span>
        basicAuth<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        reconnectCron<span class="token operator">:</span> <span class="token string">'0 0 3 * * *'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>port</code> 是弹幕源连接端口，Bot 本体需要通过这个端口连接。如果你在 <code>dmsrc.config.js</code> 文件中修改了，请记得在 <code>bot.config.js</code> 文件中的 <code>danmakuSources</code> 字段中对应端口参数也作出调整。</p> <p><code>basicAuth</code> 是 WebSocket 协议使用的简单认证手段（<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization" target="_blank" rel="noopener noreferrer">HTTP 头 Authorization 字段<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），修改后的配置方式同上，需要在 <code>bot.config.js</code> 文件同步修改。</p> <p><code>reconnectCron</code> 是弹幕源定期对所有房间重新连接的时间参数，格式请参照 <a href="https://wiki.archlinux.org/index.php/Cron#Crontab_format" target="_blank" rel="noopener noreferrer">crontab<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>其余参数在文件中有注释说明。要了解更多关于配置的说明，请移步到<a href="/bot/config.html">这里</a>。</p> <h4 id="_2-2、bot-本体配置"><a href="#_2-2、bot-本体配置" class="header-anchor">#</a> 2.2、Bot 本体配置</h4> <p>打开根目录中的 <code>bot.config.js</code> 修改 Bot 本体配置。</p> <p>（必填）在 <code>botToken</code> 字段中填入你在 <code>@BotFather</code> 创建的 Bot Token。如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>botToken<span class="token operator">:</span> <span class="token string">'123456789:AAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">,</span>
</code></pre></div><p>（必填）在 <code>botAdmins</code> 字段中填入可以通过 Telegram 对话管理 Bot 的用户 ID。如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>botAdmins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">107484754</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>（选填）如果你的机器无法直连 Telegram 服务器，可以通过 <code>botProxy</code> 设置 HTTP 代理。如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>botProxy<span class="token operator">:</span> <span class="token string">'http://127.0.0.1:8080'</span><span class="token punctuation">,</span>
</code></pre></div><p>（选填）如果你在 <code>dmsrc.config.js</code> 修改了默认的弹幕源端口，或者自行搭建了弹幕源服务，需要在 <code>danmakuSources</code> 字段中进行修改。</p> <p>要了解更多关于配置的说明，请移步到<a href="/bot/config.html">这里</a>。</p> <h4 id="_2-3、从-bot-v1-中迁移数据（选做）"><a href="#_2-3、从-bot-v1-中迁移数据（选做）" class="header-anchor">#</a> 2.3、从 Bot v1 中迁移数据（选做）</h4> <p>我们制作了数据库迁移工具，帮助你快速地从 v1 迁移到 v2，可以保留旧版本的弹幕转发配置。</p> <p>Bot Token、Telegram 代理、Bot 管理员数据等保存在 v1 版本 <code>config.js</code> 的数据并不支持直接迁移过来，你仍需要手动完成 <code>2.2</code> 步骤。</p> <blockquote><p>迁移工具只支持默认的 <code>&lt;项目目录&gt;/data</code> 位置</p></blockquote> <p>在项目根目录下执行 <code>npm run transfer:from_v1</code> 命令即可以将 Bot v1 数据库转换为 Bot v2 数据库。</p> <p>注意这个命令会直接覆盖现有的 v2 数据库，请注意备份！！</p> <h3 id="_3、启动-bot"><a href="#_3、启动-bot" class="header-anchor">#</a> 3、启动 Bot</h3> <p>现在 Bot v2 需要启动本体程序和弹幕源服务端多个进程才可正常运作，你可以在不同的 Shell 终端进程中分别执行：</p> <ul><li><code>npm run bot</code>：启动 Bot 核心进程</li> <li><code>npm run dmsrc:bilibili</code>：启动哔哩哔哩弹幕源服务端</li> <li><code>npm run dmsrc:douyu</code>：启动斗鱼弹幕源服务端</li></ul> <p>你可以使用 <code>nohup</code> 或 <code>screen</code> 等命令简单粗暴地让 Bot 的多个进程在后台运行，也可以<a href="https://wiki.archlinux.org/index.php/systemd#Writing_unit_files" target="_blank" rel="noopener noreferrer">自行编写 systemd 单元文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来构建 Bot 服务的启动管理。</p> <p>如果你不想自己编写 systemd 单元文件，也希望更优雅地管理后台进程，不妨尝试一下我们也在使用的 <a href="https://pm2.keymetrics.io/" target="_blank" rel="noopener noreferrer">PM2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 工具。</p> <p>使用 PM2 之前你可以通过 NPM 包管理进行安装到全局环境中（可能需要 root 用户权限）：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> -g pm2
</code></pre></div><p>安装好后，可以直接执行以下命令，按照我们写好的配置启动 Bot 进程：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入到项目根目录</span>
<span class="token builtin class-name">cd</span> ./danmaqua-telegrambot
<span class="token comment"># 根据 ecosystem.config.js 配置在后台启动多个进程</span>
pm2 start ecosystem.config.js
</code></pre></div><p>如果你希望机器重启后 PM2 能够为你自动启动 Bot 进程，可以执行一下命令进行配置：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 保存当前 PM2 管理的进程列表</span>
pm2 save
<span class="token comment"># 设定 PM2 自动启动（默认不支持 Windows 环境，解决方法请自行 Google）</span>
pm2 startup
</code></pre></div><p>如果你要查看 Bot 进程后台输出日志，可以执行这些命令：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 查看 Bot 核心进程日志</span>
pm2 logs danmaqua-bot
<span class="token comment"># 查看哔哩哔哩弹幕源日志</span>
pm2 logs dmsrc-bilibili
<span class="token comment"># 查看斗鱼弹幕源日志</span>
pm2 logs dmsrc-douyu
</code></pre></div><p>具体 PM2 使用方法请阅读文档或 Google 搜索关键词。</p> <h2 id="配置弹幕转发到对话或频道"><a href="#配置弹幕转发到对话或频道" class="header-anchor">#</a> 配置弹幕转发到对话或频道</h2> <p>运行起来自己的实例之后，打开与机器人的 Telegram 聊天，首次使用需要点击 Start 开始对话。</p> <p>下面提到的对话 ID 可以通过某些 ID 查询机器人获取，或者安装 Plus Messenger 或其它可信任的第三方 Telegram 客户端，打开对话/频道资料页查看 ID。通常群组和频道 ID 需要带有 <code>-100</code> 前缀才能被 Bot 识别。某些命令支持使用对话 username 代替对话 ID，无需手动查询。</p> <h3 id="为对话-频道注册弹幕转发"><a href="#为对话-频道注册弹幕转发" class="header-anchor">#</a> 为对话/频道注册弹幕转发</h3> <p>命令格式：<code>/register_chat chatId roomId [source]</code></p> <p>作用：注册指定直播房间弹幕转发到指定对话</p> <p>参数：</p> <ul><li>chatId：对话/频道 ID</li> <li>roomId：直播平台房间 ID</li> <li>source：可选项，直播平台弹幕源，默认支持 <code>bilibili</code> 和 <code>douyu</code></li></ul> <h3 id="取消对话注册"><a href="#取消对话注册" class="header-anchor">#</a> 取消对话注册</h3> <p>命令格式：<code>/unregister_chat chatId</code></p> <p>作用：取消指定对话的注册信息，会清除指定对话的其他设置</p> <p>参数：</p> <ul><li>chatId：对话/频道 ID</li></ul> <h3 id="打开管理页面"><a href="#打开管理页面" class="header-anchor">#</a> 打开管理页面</h3> <p>命令格式：<code>/manage_chats</code></p> <p>作用：列出你可以设置的频道，选择频道进行设置管理</p> <h3 id="设置对话默认过滤规则"><a href="#设置对话默认过滤规则" class="header-anchor">#</a> 设置对话默认过滤规则</h3> <p>命令格式：<code>/set_default_pattern pattern</code></p> <p>作用：所有对话默认的同传弹幕过滤规则，如果对话没有单独的规则设置，则跟随这个设置。所有弹幕会与这个正则表达式进行匹配，如果符合同传弹幕格式，则转发到指定对话中。</p> <h3 id="屏蔽用户的弹幕"><a href="#屏蔽用户的弹幕" class="header-anchor">#</a> 屏蔽用户的弹幕</h3> <p>你可以转发对话/频道中想要屏蔽的用户所发送的弹幕给 Bot，Bot 将询问是否要屏蔽指定用户。</p> <p>或者使用 <code>/manage_chats</code> 进入指定对话的管理页面，批量添加要屏蔽的用户。</p> <h3 id="其他命令"><a href="#其他命令" class="header-anchor">#</a> 其他命令</h3> <p>还有其他不常用的命令没有在这里列出，你可以在使用时输入 <code>/help</code> 进行查询。</p> <h2 id="贡献代码"><a href="#贡献代码" class="header-anchor">#</a> 贡献代码</h2> <p>本项目源码以 GPL v3 许可发布，欢迎对本项目提出 Issues 或 Pull Request。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/danmaqua/danmaqua.github.io/edit/raw/docs/bot/dev.md" target="_blank" rel="noopener noreferrer">帮助我们改善文档</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.47aadde2.js" defer></script><script src="/assets/js/2.f87f6062.js" defer></script><script src="/assets/js/10.192c4040.js" defer></script>
  </body>
</html>
